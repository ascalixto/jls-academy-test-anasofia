rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================
    // Helper functions
    // =========================
    function isSignedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function isAdmin() {
      return isSignedIn()
        && (request.auth.token.admin is bool)
        && request.auth.token.admin == true;
    }

    function isNonEmptyString(value) {
      return value is string && value.size() > 0;
    }

    function isValidStatus(status) {
      return status in ['draft', 'active', 'paused', 'shipped'];
    }

    function isValidPriority(priority) {
      return priority in ['low', 'medium', 'high'];
    }

    function isValidArchivedAt() {
      return !('archivedAt' in request.resource.data)
        || request.resource.data.archivedAt == null
        || request.resource.data.archivedAt is timestamp;
    }

    // Lesson 4.3 (search/order field)
    function isValidTitleLower() {
      return !('titleLower' in request.resource.data)
        || isNonEmptyString(request.resource.data.titleLower);
    }

    // =========================
    // productIdeas collection
    // =========================
    match /productIdeas/{ideaId} {

      // READ & LIST
      allow get, list: if isSignedIn();

      // CREATE
      allow create: if isSignedIn()
        && request.resource.data.ownerId == uid()
        && isNonEmptyString(request.resource.data.title)
        && isNonEmptyString(request.resource.data.summary)
        && isNonEmptyString(request.resource.data.titleLower)
        && isValidStatus(request.resource.data.status)
        && isValidPriority(request.resource.data.priority)
        && request.resource.data.tags is list
        && isValidArchivedAt()
        && isValidTitleLower();

      // UPDATE
      allow update: if isSignedIn()
        && (
          resource.data.ownerId == uid()
          || isAdmin()
        )
        && request.resource.data.ownerId == resource.data.ownerId
        && isNonEmptyString(request.resource.data.title)
        && isNonEmptyString(request.resource.data.summary)
        && isNonEmptyString(request.resource.data.titleLower)
        && isValidStatus(request.resource.data.status)
        && isValidPriority(request.resource.data.priority)
        && request.resource.data.tags is list
        && isValidArchivedAt()
        && isValidTitleLower();

      // DELETE
      allow delete: if isSignedIn()
        && resource.data.ownerId == uid();

      // =========================
      // notes subcollection
      // =========================
      match /notes/{noteId} {

        // READ & LIST
        allow get, list: if isSignedIn();

        // CREATE
        allow create: if isSignedIn()
          && request.resource.data.authorId == uid()
          && isNonEmptyString(request.resource.data.body);

        // UPDATE
        allow update: if false;

        // DELETE
        allow delete: if isSignedIn()
          && resource.data.authorId == uid();
      }
    }
  }
}